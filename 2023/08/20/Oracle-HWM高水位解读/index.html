

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Li zhihao">
  <meta name="keywords" content="">
  
    <meta name="description" content="前言今天在工作中遇到一个数据不算多但是查询很慢的表，导致了其他关联业务出错，一开始很疑惑，查找了资料以及询问了同事，确定了应该是表高水平位的问题。 在此之前并没有学习了解过该问题，于是搜索了许多资料，看见了这篇解读很不错，故转载记录下来 Oracle-HWM(High Water Mark) 高水位解读读前须知：Oracle的逻辑存储管理  ORACLE在逻辑存储上分4个粒度 ，由大到小为: 表空">
<meta property="og:type" content="article">
<meta property="og:title" content="Oracle-HWM高水位解读">
<meta property="og:url" content="http://example.com/2023/08/20/Oracle-HWM%E9%AB%98%E6%B0%B4%E4%BD%8D%E8%A7%A3%E8%AF%BB/index.html">
<meta property="og:site_name" content="Lizhihao&#39;s Blog">
<meta property="og:description" content="前言今天在工作中遇到一个数据不算多但是查询很慢的表，导致了其他关联业务出错，一开始很疑惑，查找了资料以及询问了同事，确定了应该是表高水平位的问题。 在此之前并没有学习了解过该问题，于是搜索了许多资料，看见了这篇解读很不错，故转载记录下来 Oracle-HWM(High Water Mark) 高水位解读读前须知：Oracle的逻辑存储管理  ORACLE在逻辑存储上分4个粒度 ，由大到小为: 表空">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/yehe-8916337/97aee2e6726950de9fc3ffb5440babc3.png">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/yehe-8916337/91990da12f13dbb045676b54a62bf254.png">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/yehe-8916337/b0a6a9c66cf9f80153279b86358337c1.png">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/yehe-8916337/39af1ff0e4ce6acc7f6f2e5cbef1b58f.png">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/yehe-8916337/5100b5843ea21ff67a52a7d558c3fb32.png">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/yehe-8916337/8679932a32ce4b119bd8351f1f4386a3.png">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/yehe-8916337/c3406fdc5da5c7287e1b743d05c00f82.png">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/yehe-8916337/a7f635ef83b3321301b5897db5ddb157.png">
<meta property="article:published_time" content="2023-08-20T11:13:38.000Z">
<meta property="article:modified_time" content="2023-08-21T15:31:34.924Z">
<meta property="article:author" content="Li zhihao">
<meta property="article:tag" content="Oracle表高水位">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://ask.qcloudimg.com/http-save/yehe-8916337/97aee2e6726950de9fc3ffb5440babc3.png">
  
  
  
  <title>Oracle-HWM高水位解读 - Lizhihao&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Lizhihao&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/8.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Oracle-HWM高水位解读"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-08-20 19:13" pubdate>
          2023年8月20日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          9.3k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          78 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Oracle-HWM高水位解读</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>今天在工作中遇到一个数据不算多但是查询很慢的表，导致了其他关联业务出错，一开始很疑惑，查找了资料以及询问了同事，确定了应该是表高水平位的问题。</p>
<p>在此之前并没有学习了解过该问题，于是搜索了许多资料，看见了这篇解读很不错，故转载记录下来</p>
<h2 id="Oracle-HWM-High-Water-Mark-高水位解读"><a href="#Oracle-HWM-High-Water-Mark-高水位解读" class="headerlink" title="Oracle-HWM(High Water Mark) 高水位解读"></a>Oracle-HWM(High Water Mark) 高水位解读</h2><h1 id="读前须知：Oracle的逻辑存储管理"><a href="#读前须知：Oracle的逻辑存储管理" class="headerlink" title="读前须知：Oracle的逻辑存储管理"></a>读前须知：Oracle的逻辑存储管理</h1><hr>
<p> ORACLE在逻辑存储上分4个粒度 ，由大到小为: 表空间, 段, 区 和 块. </p>
<hr>
<h2 id="块Block"><a href="#块Block" class="headerlink" title="块Block"></a>块Block</h2><p> 块:是粒度最小的存储单位,现在标准的块大小是8K,ORACLE每一次I&#x2F;O操作也是按块来操作的,也就是说当ORACLE从数据文件读数据时,是读取多少个块,而不是多少行. 每一个Block里可以包含多个row. </p>
<p>数据块的大小是通过kb字节个数来指定的，默认为8KB。相关参数为db_block_size</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-variable constant_">SQL</span>&gt; show parameter db_block_size<br><br><span class="hljs-variable constant_">NAME</span>                                 <span class="hljs-variable constant_">TYPE</span>        <span class="hljs-variable constant_">VALUE</span><br>----------------------- --------------------- ---------<br>db_block_size                        integer     <span class="hljs-number">8192</span><br></code></pre></td></tr></table></figure>

<p>复制</p>
<hr>
<h2 id="区Extent"><a href="#区Extent" class="headerlink" title="区Extent"></a>区Extent</h2><p>由一系列相邻的块而组成,这也是ORACLE空间分配的基本单位.</p>
<p>区extent是比数据块大一级的存储结构，表示的是一连串连续的数据块集合。</p>
<p>在进行存储数据信息的时候，Oracle将分配数据块进行存储，但是不能保证所有分配的数据块都是连续的结构。</p>
<p>所以，出现分区extent的概念，表示一系列连续的数据块集合。</p>
<p>举个例子来说,当我们创建一个表时,首先ORACLE会分配一区的空间给这个表,随着数据不断地增长,原来的这个区容不下插入的数据时,ORACLE是以区为单位进行扩展的,也就是说再分配多少个区给这个表,而不是多少个块.</p>
<p>视图dba_extents（或者all_extents、user_extents）是我们研究分区结构和存储构成的重要手段。</p>
<hr>
<h2 id="段Segment"><a href="#段Segment" class="headerlink" title="段Segment"></a>段Segment</h2><p>段: 是由一系列的区extent所组成</p>
<p>数据段是与<a target="_blank" rel="noopener" href="https://cloud.tencent.com/solution/database?from_column=20065&from=20065">数据库</a>对象相对应，一般一个数据库对象对应一个数据段。</p>
<p>多个extent是对应一个数据段，每个数据段实际上就是数据库一个对象的代表。</p>
<p>一般来说, 当创建一个对象时(表,索引),就会分配一个段给这个对象.</p>
<p>从dba_segments、user_segments视图中，可以比较清楚看清数据段的结构。</p>
<hr>
<h2 id="表空间Tablespace"><a href="#表空间Tablespace" class="headerlink" title="表空间Tablespace"></a>表空间Tablespace</h2><p>TableSpace是存储结构中的最高层结构。建立一个表空间的时候，是需要指定存储的文件。一个表空间可以指定多个数据文件，多个文件可以在不同的物理存储上。也就是说，表空间是可以跨物理存储的。</p>
<p>但是有一点就是，表空间下一级对象数据段的存储，是不能指定存储在那个文件里的。所以，要想让数据对象访问IO<a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/clb?from_column=20065&from=20065">负载均衡</a>，需要指定不同的数据对象在不同的表空间里。这也就是为什么将数据表和索引建立在不同的表空间的原因。</p>
<p>表空间通过v$tablespace进行访问 </p>
<p><img src="https://ask.qcloudimg.com/http-save/yehe-8916337/97aee2e6726950de9fc3ffb5440babc3.png" srcset="/img/loading.gif" lazyload alt="这里写图片描述"></p>
<p>其中两个参数需要注意一下。</p>
<p>一个是bigfile，是一个标志位，标志表空间是不是所谓的大文件表空间。</p>
<blockquote>
<p> 大文件表空间是在10g中推出的一个新特性，处于性能考虑，可以设置表空间为大文件表空间，存储超过百T的数据，但是要求数据文件只能有一个。 </p>
</blockquote>
<p>另一个是flashback_on，表示表空间的闪回特性是否开启。</p>
<p>还有 dba_tablespaces 、 user_tablespaces。</p>
<hr>
<h1 id="Oracle表段中的高水位线HWM"><a href="#Oracle表段中的高水位线HWM" class="headerlink" title="Oracle表段中的高水位线HWM"></a>Oracle表段中的高水位线HWM</h1><p>在数据库表刚建立的时候，由于没有任何数据，所以这个时候水位线是空的，也就是说HWM为最低值。</p>
<p>当插入了数据以后，高水位线就会上涨，但如果你采用delete语句删除数据的话，数据虽然被删除了，但是高水位线却没有降低，还是你刚才删除数据以前那么高的水位。</p>
<p>也就是说，这条高水位线在日常的增删操作中只会上涨，不会下跌。</p>
<p>HWM通常增长的幅度为一次5个数据块.</p>
<p>Select语句会对表中的数据进行一次扫描，但是究竟扫描多少<a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/cdcs?from_column=20065&from=20065">数据存储</a>块呢，这个并不是说数据库中有多少数据，Oracle就扫描这么大的数据块，而是Oracle会扫描高水位线以下的数据块。</p>
<p>试想一下，新建的一个空表，Select一下，由于高水位线HWM在最低的0位置上，所以没有数据块需要被扫描，扫描时间会极短。</p>
<p>如果这个时候你首先插入了一千万条数据，然后再用delete语句删除这一千万条数据。由于插入了一千万条数据，所以这个时候的高水位线就在一千万条数据这里。后来删除这一千万条数据的时候，由于delete语句不影响高水位线，所以高水位线依然在一千万条数据这里。</p>
<p>这个时候再一次用select语句进行扫描，虽然这个时候表中没有数据，但是由于扫描是按照高水位线来的，所以需要把一千万条数据的存储空间都要扫描一次，也就是说这次扫描所需要的时间和扫描一千万条数据所需要的时间是一样多的。所以有时候有人总是经常说，怎么我的表中没有几条数据，但是还是这么慢呢，这个时候其实奥秘就是这里的高水位线了。</p>
<p>那有没有办法让高水位线下降呢 ? 采用TRUNCATE语句删除一个表的数据的时候，类似于重新建立了表，不仅把数据都删除了，还把HWM给清空恢复为0。</p>
<p>所以如果需要把表清空，在有可能利用TRUNCATE语句来删除数据的时候就利用TRUNCATE语句来删除表，特别是那种数据量有可能很大的临时存储表。</p>
<hr>
<p>在手动段空间管理（Manual Segment Space Management）中，段中只有一个HWM，</p>
<p>但是在Oracle 9i Release1才添加的自动段空间管理（Automatic Segment Space Management）中，又有了一个低HWM的概念出来。</p>
<p>为什么有了HWM还又有一个低HWM呢，这个是因为自动段空间管理的特性造成的。在手段段空间管理中，当数据插入以后，如果是插入到新的数据块中，数据块就会被自动格式化等待数据访问。</p>
<p>而在自动段空间管理中，数据插入到新的数据块以后，数据块并没有被格式化，而是在第一次访问这个数据块的时候才格式化这个块。</p>
<p>所以我们又需要一条水位线，用来标示已经被格式化的块。这条水位线就叫做低HWM。一般来说，低HWM肯定是低于等于HWM的。</p>
<hr>
<h1 id="降低ORACLE表的高水位线"><a href="#降低ORACLE表的高水位线" class="headerlink" title="降低ORACLE表的高水位线"></a>降低ORACLE表的高水位线</h1><p>在ORACLE中，执行对表的删除操作不会降低该表的高水位线。而全表扫描将始终读取一个段(extent)中所有低于高水位线标记的块。如果在执行删除操作后不降低高水位线标记，则将导致查询语句的性能低下。</p>
<p>rebuild, truncate, shrink,move 等操作会降低高水位。</p>
<h2 id="执行表重建指令-alter-table-table-name-move"><a href="#执行表重建指令-alter-table-table-name-move" class="headerlink" title="执行表重建指令 alter table table_name move"></a>执行表重建指令 alter table table_name move</h2><p>在线转移表空间ALTER TABLE … MOVE TABLESPACE ..</p>
<p>当你创建了一个对象如表以后,不管你有没有插入数据,它都会占用一些块,ORACLE也会给它分配必要的空间.</p>
<p>同样,用ALTER TABLE MOVE释放自由空间后,还是保留了一些空间给这个表. </p>
<p>ALTER TABLE … MOVE 后面不跟参数也行，不跟参数表还是在原来的表空间，Move后记住重建索引.</p>
<p> 如果以后还要继续向这个表增加数据，没有必要move， 只是释放出来的空间，只能这个表用，其他的表或者segment无法使用该空间。</p>
<hr>
<h2 id="执行alter-table-table-name-shrink-space-10g新功能"><a href="#执行alter-table-table-name-shrink-space-10g新功能" class="headerlink" title="执行alter table table_name shrink space-10g新功能"></a>执行alter table table_name shrink space-10g新功能</h2><p>此命令为Oracle 10g新增功能，再执行该指令之前必须允许行移动 alter table table_name enable row movement;</p>
<p>如果要同时压缩表的索引,可以发布:alter table test_tab shrink space cascade</p>
<hr>
<h2 id="重建表"><a href="#重建表" class="headerlink" title="重建表"></a>重建表</h2><p>复制要保留的数据到临时表t，drop原表，然后rename临时表t为原表</p>
<hr>
<h2 id="用逻辑导入导出-Emp-Imp"><a href="#用逻辑导入导出-Emp-Imp" class="headerlink" title="用逻辑导入导出: Emp&#x2F;Imp"></a>用逻辑导入导出: Emp&#x2F;Imp</h2><hr>
<h2 id="Alter-table-table-name-deallocate-unused"><a href="#Alter-table-table-name-deallocate-unused" class="headerlink" title="Alter table table_name deallocate unused"></a>Alter table table_name deallocate unused</h2><p>DEALLOCATE UNUSED会释放HWM上面的未使用空间,但是并不会释放HWM下面的自由空间,也不会移动HWM的位置.</p>
<hr>
<h2 id="truncate-推荐使用"><a href="#truncate-推荐使用" class="headerlink" title="truncate(推荐使用)"></a>truncate(推荐使用)</h2><p>truncate table xxx</p>
<hr>
<h1 id="HWM的特征"><a href="#HWM的特征" class="headerlink" title="HWM的特征"></a>HWM的特征</h1><h2 id="ORACLE用HWM来界定一个段中使用的块和未使用的块"><a href="#ORACLE用HWM来界定一个段中使用的块和未使用的块" class="headerlink" title="ORACLE用HWM来界定一个段中使用的块和未使用的块"></a>ORACLE用HWM来界定一个段中使用的块和未使用的块</h2><p>当我们创建一个表时,ORACLE就会为这个对象分配一个段.在这个段中,即使我们未插入任何记录,也至少有一个区被分配,第一个区的第一个块就称为段头(SEGMENT HEADE),段头中就储存了一些信息,HWM的信息就存储在此.</p>
<p>我们不断插入数据时,HWM会往不断上移,这样,在HWM之下的,就表示使用过的块,HWM之上的就表示已分配但从未使用过的块.</p>
<hr>
<h2 id="HWM在插入数据时-当现有空间不足而进行空间的扩展时会向上移-但删除数据时不会往下移"><a href="#HWM在插入数据时-当现有空间不足而进行空间的扩展时会向上移-但删除数据时不会往下移" class="headerlink" title="HWM在插入数据时,当现有空间不足而进行空间的扩展时会向上移,但删除数据时不会往下移."></a>HWM在插入数据时,当现有空间不足而进行空间的扩展时会向上移,但删除数据时不会往下移.</h2><p>ORACLE 不会释放空间以供其他对象使用，有一条简单的理由：由于空间是为新插入的行保留的，并且要适应现有行的增长。被占用的最高空间称为最高使用标记 (HWM).</p>
<hr>
<h2 id="HWM的信息存储在段头当中"><a href="#HWM的信息存储在段头当中" class="headerlink" title="HWM的信息存储在段头当中."></a>HWM的信息存储在段头当中.</h2><p>HWM本身的信息是储存在段头.</p>
<p>在段空间是手工管理方式时,ORACLE是通过FREELIST(一个单向链表)来管理段内的空间分配.</p>
<p>在段空间是自动管理方式时(ASSM),ORACLE是通过BITMAP来管理段内的空间分配.</p>
<hr>
<h2 id="ORACLE的全表扫描是读取高水位标记-HWM-以下的所有块"><a href="#ORACLE的全表扫描是读取高水位标记-HWM-以下的所有块" class="headerlink" title="ORACLE的全表扫描是读取高水位标记(HWM)以下的所有块."></a>ORACLE的全表扫描是读取高水位标记(HWM)以下的所有块.</h2><p>所以问题就产生了.当用户发出一个全表扫描时，ORACLE 始终必须从段一直扫描到 HWM，即使它什么也没有发现。</p>
<p>该任务延长了全表扫描的时间。</p>
<hr>
<h2 id="当用直接路径插入行时，即使HWM以下有空闲的数据库块，键入在插入数据时使用了append关键字，则在插入时使用HWM以上的数据块，此时HWM会自动增大。"><a href="#当用直接路径插入行时，即使HWM以下有空闲的数据库块，键入在插入数据时使用了append关键字，则在插入时使用HWM以上的数据块，此时HWM会自动增大。" class="headerlink" title="当用直接路径插入行时，即使HWM以下有空闲的数据库块，键入在插入数据时使用了append关键字，则在插入时使用HWM以上的数据块，此时HWM会自动增大。"></a>当用直接路径插入行时，即使HWM以下有空闲的数据库块，键入在插入数据时使用了append关键字，则在插入时使用HWM以上的数据块，此时HWM会自动增大。</h2><p>例如，通过直接加载插入（用 APPEND 提示插入）或通过 SQL*LOADER 直接路径 数据块直接置于 HWM 之上。它下面的空间就浪费掉了。</p>
<hr>
<h1 id="栗子"><a href="#栗子" class="headerlink" title="栗子"></a>栗子</h1><p>数据库版本 Connected to Oracle Database 11g Enterprise Edition Release <strong>11.2.0.4.0</strong> </p>
<h2 id="创建测试表"><a href="#创建测试表" class="headerlink" title="创建测试表"></a>创建测试表</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-variable constant_">SQL</span>&gt; create table <span class="hljs-title function_">tt</span>(id number);<br><br><span class="hljs-title class_">Table</span> created<br></code></pre></td></tr></table></figure>

<p>复制</p>
<p>此时表没有分析，是原始的数据，即8个数据块。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs javascript">--空的<br><span class="hljs-variable constant_">SQL</span>&gt; <span class="hljs-variable constant_">SELECT</span> segment_name,segment_type,blocks <span class="hljs-variable constant_">FROM</span> dba_segments  a  <span class="hljs-variable constant_">WHERE</span> a.<span class="hljs-property">segment_name</span> = <span class="hljs-string">&#x27;TT&#x27;</span>;<br><br><span class="hljs-variable constant_">SEGMENT_NAME</span>                                                  <span class="hljs-variable constant_">SEGMENT_TYPE</span>     <span class="hljs-variable constant_">BLOCKS</span><br>-------------------------------------------------------------------------------- ------------------ ----------<br> --空的<br><span class="hljs-variable constant_">SQL</span>&gt; <span class="hljs-variable constant_">SELECT</span> table_name,num_rows,blocks,empty_blocks <span class="hljs-variable constant_">FROM</span> user_tables  <span class="hljs-variable constant_">WHERE</span> table_name=<span class="hljs-string">&#x27;TT&#x27;</span>;<br><br><span class="hljs-variable constant_">TABLE_NAME</span>         <span class="hljs-variable constant_">NUM_ROWS</span>     <span class="hljs-variable constant_">BLOCKS</span> <span class="hljs-variable constant_">EMPTY_BLOCKS</span><br>------------------------------ ---------- ---------- ------------<br><span class="hljs-variable constant_">TT</span>                                                 <br></code></pre></td></tr></table></figure>

<p>复制</p>
<h2 id="向表中插入一些测试数据"><a href="#向表中插入一些测试数据" class="headerlink" title="向表中插入一些测试数据"></a>向表中插入一些测试数据</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-variable constant_">SQL</span>&gt; declare<br>  <span class="hljs-number">2</span>    i number;<br>  <span class="hljs-number">3</span>  begin<br>  <span class="hljs-number">4</span>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">1</span> .. <span class="hljs-number">10000</span> loop<br>  <span class="hljs-number">5</span>      insert into tt values (i);<br>  <span class="hljs-number">6</span>    end loop;<br>  <span class="hljs-number">7</span>    commit;<br>  <span class="hljs-number">8</span>  end;<br>  <span class="hljs-number">9</span>  /<br><br><span class="hljs-variable constant_">PL</span>/<span class="hljs-variable constant_">SQL</span> procedure successfully completed<br></code></pre></td></tr></table></figure>

<p>复制</p>
<h2 id="重新查询表的信息"><a href="#重新查询表的信息" class="headerlink" title="重新查询表的信息"></a>重新查询表的信息</h2><p><img src="https://ask.qcloudimg.com/http-save/yehe-8916337/91990da12f13dbb045676b54a62bf254.png" srcset="/img/loading.gif" lazyload alt="这里写图片描述"></p>
<p>此时表TT 占用的块已经是24个了.</p>
<p>但是user_tables 显示的信息还是为空。 因为没有做统计分析。</p>
<h2 id="收集统计信息"><a href="#收集统计信息" class="headerlink" title="收集统计信息"></a>收集统计信息</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-variable constant_">SQL</span>&gt;  exec <span class="hljs-variable constant_">DBMS_STATS</span>.<span class="hljs-title function_">GATHER_TABLE_STATS</span>(user,<span class="hljs-string">&#x27;TT&#x27;</span>);<br><br><span class="hljs-variable constant_">PL</span>/<span class="hljs-variable constant_">SQL</span> procedure successfully completed<br></code></pre></td></tr></table></figure>

<p>复制</p>
<p>再此查询一下</p>
<p><img src="https://ask.qcloudimg.com/http-save/yehe-8916337/b0a6a9c66cf9f80153279b86358337c1.png" srcset="/img/loading.gif" lazyload alt="这里写图片描述"></p>
<p>此时user_tables 已经有了数据，显示的使用了20个数据块。 但是empty_blocks 还是为空。 这里要注意的地方。 empty_blocks 这个字段只有使用analyze 收集统计信息之后才会有数据。</p>
<hr>
<h2 id="使用analyze搜集统计信息"><a href="#使用analyze搜集统计信息" class="headerlink" title="使用analyze搜集统计信息"></a>使用analyze搜集统计信息</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-variable constant_">SQL</span>&gt; analyze table tt compute statistics;<br><br><span class="hljs-title class_">Table</span> analyzed<br></code></pre></td></tr></table></figure>

<p>复制</p>
<p><img src="https://ask.qcloudimg.com/http-save/yehe-8916337/39af1ff0e4ce6acc7f6f2e5cbef1b58f.png" srcset="/img/loading.gif" lazyload alt="这里写图片描述"></p>
<h2 id="delete-数据，不会降低高水位"><a href="#delete-数据，不会降低高水位" class="headerlink" title="delete 数据，不会降低高水位"></a>delete 数据，不会降低高水位</h2><p><img src="https://ask.qcloudimg.com/http-save/yehe-8916337/5100b5843ea21ff67a52a7d558c3fb32.png" srcset="/img/loading.gif" lazyload alt="这里写图片描述"></p>
<p><img src="https://ask.qcloudimg.com/http-save/yehe-8916337/8679932a32ce4b119bd8351f1f4386a3.png" srcset="/img/loading.gif" lazyload alt="这里写图片描述"></p>
<p>可以发现 分析前后，blocks 和 empty_blocks 都没有发生变化。</p>
<hr>
<h2 id="truncate-表，可以降低高水位"><a href="#truncate-表，可以降低高水位" class="headerlink" title="truncate 表，可以降低高水位"></a>truncate 表，可以降低高水位</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs javascript">--truncate 表<br><span class="hljs-variable constant_">SQL</span>&gt; truncate table tt;<br><br><span class="hljs-title class_">Table</span> truncated<br><br><br>--查询段信息，blocks由<span class="hljs-number">24</span>降到了<span class="hljs-number">8</span><br><span class="hljs-variable constant_">SQL</span>&gt;  <span class="hljs-variable constant_">SELECT</span> segment_name,segment_type,blocks <span class="hljs-variable constant_">FROM</span> dba_segments  <span class="hljs-variable constant_">WHERE</span> segment_name=<span class="hljs-string">&#x27;TT&#x27;</span>;<br><br><span class="hljs-variable constant_">SEGMENT_NAME</span>       <span class="hljs-variable constant_">SEGMENT_TYPE</span>     <span class="hljs-variable constant_">BLOCKS</span><br>---------         ----------       ----------<br><span class="hljs-variable constant_">TT</span>                  <span class="hljs-variable constant_">TABLE</span>            <span class="hljs-number">8</span><br><br>--查询表信息，没有改变<br><span class="hljs-variable constant_">SQL</span>&gt;   <span class="hljs-variable constant_">SELECT</span> table_name,num_rows,blocks,empty_blocks <span class="hljs-variable constant_">FROM</span> user_tables  <span class="hljs-variable constant_">WHERE</span> table_name=<span class="hljs-string">&#x27;TT&#x27;</span>;<br><br><br><span class="hljs-variable constant_">TABLE_NAME</span>    <span class="hljs-variable constant_">NUM_ROWS</span>    <span class="hljs-variable constant_">BLOCKS</span>    <span class="hljs-variable constant_">EMPTY_BLOCKS</span><br>--------     ----------    ------     ------<br><span class="hljs-variable constant_">TT</span>                 <span class="hljs-number">0</span>         <span class="hljs-number">20</span>         <span class="hljs-number">4</span><br><br><br>------------------------------------------------------------<br>------------------------------------------------------------<br><br><br> --收集下表信息<br><span class="hljs-variable constant_">SQL</span>&gt;  exec dbms_stats.<span class="hljs-title function_">gather_table_stats</span>(user,<span class="hljs-string">&#x27;TT&#x27;</span>);<br><br><span class="hljs-variable constant_">PL</span>/<span class="hljs-variable constant_">SQL</span> procedure successfully completed<br><br>--重新统计下段信息，一样<br><span class="hljs-variable constant_">SQL</span>&gt; <span class="hljs-variable constant_">SELECT</span> segment_name,segment_type,blocks <span class="hljs-variable constant_">FROM</span> dba_segments  <span class="hljs-variable constant_">WHERE</span> segment_name=<span class="hljs-string">&#x27;TT&#x27;</span>;<br><br><span class="hljs-variable constant_">SEGMENT_NAME</span>       <span class="hljs-variable constant_">SEGMENT_TYPE</span>     <span class="hljs-variable constant_">BLOCKS</span><br>---------         ----------       ----------<br><span class="hljs-variable constant_">TT</span>                  <span class="hljs-variable constant_">TABLE</span>            <span class="hljs-number">8</span><br><br>--重新查询表信息 <span class="hljs-variable constant_">BLOCKS</span> 由<span class="hljs-number">20</span>降为<span class="hljs-number">0</span>， 但是empyt_blocks 还是<span class="hljs-number">4</span>个<br><span class="hljs-variable constant_">SQL</span>&gt;  <span class="hljs-variable constant_">SELECT</span> table_name,num_rows,blocks,empty_blocks <span class="hljs-variable constant_">FROM</span> user_tables  <span class="hljs-variable constant_">WHERE</span> table_name=<span class="hljs-string">&#x27;TT&#x27;</span>;<br><br><span class="hljs-variable constant_">TABLE_NAME</span>  <span class="hljs-variable constant_">NUM_ROWS</span>     <span class="hljs-variable constant_">BLOCKS</span>       <span class="hljs-variable constant_">EMPTY_BLOCKS</span><br>---------- -----       ----------   ------------<br><span class="hljs-variable constant_">TT</span>           <span class="hljs-number">0</span>             <span class="hljs-number">0</span>            <span class="hljs-number">4</span><br><br><br>--analyze 分析下 更改<span class="hljs-variable constant_">EMPTY_BLOCKS</span>的值<br><span class="hljs-variable constant_">SQL</span>&gt; analyze table tt compute statistics;<br><br><span class="hljs-title class_">Table</span> analyzed<br><br> --重新查询段信息，<br><span class="hljs-variable constant_">SQL</span>&gt;  <span class="hljs-variable constant_">SELECT</span> segment_name,segment_type,blocks <span class="hljs-variable constant_">FROM</span> dba_segments  <span class="hljs-variable constant_">WHERE</span> segment_name=<span class="hljs-string">&#x27;TT&#x27;</span>;<br><br><span class="hljs-variable constant_">SEGMENT_NAME</span>       <span class="hljs-variable constant_">SEGMENT_TYPE</span>     <span class="hljs-variable constant_">BLOCKS</span><br>---------         ----------       ----------<br><span class="hljs-variable constant_">TT</span>                  <span class="hljs-variable constant_">TABLE</span>            <span class="hljs-number">8</span><br><br> --重新查询表信息<br><span class="hljs-variable constant_">SQL</span>&gt; <span class="hljs-variable constant_">SELECT</span> table_name,num_rows,blocks,empty_blocks <span class="hljs-variable constant_">FROM</span> user_tables  <span class="hljs-variable constant_">WHERE</span> table_name=<span class="hljs-string">&#x27;TT&#x27;</span>;<br><br><span class="hljs-variable constant_">TABLE_NAME</span>  <span class="hljs-variable constant_">NUM_ROWS</span>     <span class="hljs-variable constant_">BLOCKS</span>       <span class="hljs-variable constant_">EMPTY_BLOCKS</span><br>---------- -----       ----------   ------------<br><span class="hljs-variable constant_">TT</span>           <span class="hljs-number">0</span>             <span class="hljs-number">0</span>            <span class="hljs-number">8</span><br><br><span class="hljs-variable constant_">SQL</span>&gt; <br></code></pre></td></tr></table></figure>

<p>复制</p>
<p>总共8个数据块，8个为空</p>
<hr>
<h1 id="Alter-table-move-和Shrink的区别"><a href="#Alter-table-move-和Shrink的区别" class="headerlink" title="Alter table move 和Shrink的区别"></a>Alter table move 和Shrink的区别</h1><h2 id="Shrink"><a href="#Shrink" class="headerlink" title="Shrink"></a>Shrink</h2><p>在10g之后，整理碎片消除行迁移的新增功能shrink space</p>
<p>语法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">alter table  shrink space [ &lt;<span class="hljs-literal">null</span>&gt; | compact | cascade ];<br></code></pre></td></tr></table></figure>

<p>复制</p>
<ul>
<li>compact: 这个参数当系统的负载比较大时可以用，不降低HWM。如果系统负载较低时，直接用alter table table_name shrink space就一步到位了</li>
<li>cascade：这个参数是在shrink table的时候自动级联索引，相当于rebulid index。</li>
</ul>
<p>基于普通表</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs javascript">--shrink必须开启行迁移功能。<br>alter table table_name enable row movement ;<br><br>--保持<span class="hljs-variable constant_">HWM</span>，相当于把块中数据打结实了<br>alter table table_name shrink space compact;<br><br>--回缩表与降低<span class="hljs-variable constant_">HWM</span><br>alter table table_name shrink space;<br><br>--回缩表与相关索引，降低<span class="hljs-variable constant_">HWM</span><br>alter table table_name shrink space cascade;<br><br>--回缩索引与降低<span class="hljs-variable constant_">HWM</span><br>alter index index_name shrink space<br></code></pre></td></tr></table></figure>

<p>复制</p>
<p>虽然在10g中可以用shrink ，但也有些限制：</p>
<ul>
<li>1). 对cluster，cluster table，或具有Long，lob类型列的对象 不起作用。</li>
<li>2). 不支持具有function-based indexes 或 bitmap join indexes的表</li>
<li>3). 不支持mapping 表或index-organized表。</li>
<li>4). 不支持compressed 表</li>
</ul>
<hr>
<h2 id="shrink栗子"><a href="#shrink栗子" class="headerlink" title="shrink栗子"></a>shrink栗子</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-variable constant_">SQL</span>&gt; create table <span class="hljs-title function_">tt</span>(id number);<br><br><br><span class="hljs-variable constant_">SQL</span>&gt; declare<br>  i number;<br>begin<br>  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">1</span> .. <span class="hljs-number">10000</span> loop<br>    insert into tt values (i);<br>  end loop;<br>  commit;<br>end;<br><br><br><br><span class="hljs-variable constant_">SQL</span>&gt; exec  <span class="hljs-variable constant_">DBMS_STATS</span>.<span class="hljs-title function_">GATHER_TABLE_STATS</span>(user,<span class="hljs-string">&#x27;TT&#x27;</span>);<br><br><br><br><br><span class="hljs-variable constant_">SQL</span>&gt;  analyze table tt compute statistics;<br><br><br><br><br><br> <span class="hljs-variable constant_">SQL</span>&gt; <span class="hljs-keyword">delete</span> <span class="hljs-keyword">from</span> tt;<br> <span class="hljs-variable constant_">SQL</span>&gt; commit ;<br><br><span class="hljs-variable constant_">SQL</span>&gt; alter table tt enable row movement ;<br><span class="hljs-variable constant_">SQL</span>&gt; alter table tt  shrink space;<br><span class="hljs-variable constant_">SQL</span>&gt; analyze table tt compute statistics;<br><br><br><span class="hljs-variable constant_">SQL</span>&gt; <span class="hljs-variable constant_">SELECT</span> segment_name,segment_type,blocks <span class="hljs-variable constant_">FROM</span> dba_segments  <span class="hljs-variable constant_">WHERE</span> segment_name=<span class="hljs-string">&#x27;TT&#x27;</span>;<br><br><span class="hljs-variable constant_">SQL</span>&gt; <span class="hljs-variable constant_">SELECT</span> table_name,num_rows,blocks,empty_blocks <span class="hljs-variable constant_">FROM</span> user_tables  <span class="hljs-variable constant_">WHERE</span> table_name=<span class="hljs-string">&#x27;TT&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p>复制</p>
<p><img src="https://ask.qcloudimg.com/http-save/yehe-8916337/c3406fdc5da5c7287e1b743d05c00f82.png" srcset="/img/loading.gif" lazyload alt="这里写图片描述"></p>
<p><img src="https://ask.qcloudimg.com/http-save/yehe-8916337/a7f635ef83b3321301b5897db5ddb157.png" srcset="/img/loading.gif" lazyload alt="这里写图片描述"></p>
<hr>
<h2 id="Move"><a href="#Move" class="headerlink" title="Move"></a>Move</h2><p>通过desc table_name 来检查表中是否有LOB 字段，</p>
<h3 id="表中没有lob字段"><a href="#表中没有lob字段" class="headerlink" title="表中没有lob字段"></a>表中没有lob字段</h3><p>如果表没有LOB字段， 直接 alter table move; 然后 rebuild index</p>
<h3 id="表中包含了LOB字段"><a href="#表中包含了LOB字段" class="headerlink" title="表中包含了LOB字段"></a>表中包含了LOB字段</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">alter table owner.<span class="hljs-property">table_name</span> move tablespace tablespace_name lob (lob_column) store <span class="hljs-keyword">as</span> lobsegment tablespace tablespace_name;<br></code></pre></td></tr></table></figure>

<p>复制</p>
<p>也可以单独move lob，但是表上的index 同样会失效. 所以在操作结束，需要对索引进行rebuild。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">alter table owner.<span class="hljs-property">table_name</span> move <span class="hljs-title function_">lob</span>(lob_column) store <span class="hljs-keyword">as</span> lobsegment tablespace tablespace_name ;<br></code></pre></td></tr></table></figure>

<p>复制</p>
<p>索引的rebuild：</p>
<p>首先用下面的SQL查看表上面有哪类索引:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-variable constant_">SELECT</span> a.<span class="hljs-property">owner</span>,<br>       a.<span class="hljs-property">index_name</span>,<br>       a.<span class="hljs-property">index_type</span>,<br>       a.<span class="hljs-property">partitioned</span>,<br>       a.<span class="hljs-property">status</span>,<br>       b.<span class="hljs-property">status</span> p_status,<br>       b.<span class="hljs-property">composite</span><br>  <span class="hljs-variable constant_">FROM</span>    dba_indexes a<br>       <span class="hljs-variable constant_">LEFT</span> <span class="hljs-variable constant_">JOIN</span><br>          dba_ind_partitions b<br>       <span class="hljs-variable constant_">ON</span> a.<span class="hljs-property">owner</span> = b.<span class="hljs-property">index_owner</span> <span class="hljs-variable constant_">AND</span> a.<span class="hljs-property">index_name</span> = b.<span class="hljs-property">index_name</span><br> <span class="hljs-variable constant_">WHERE</span> a.<span class="hljs-property">owner</span> = <span class="hljs-string">&#x27;&amp;owner&#x27;</span> <span class="hljs-variable constant_">AND</span> a.<span class="hljs-property">table_name</span> = <span class="hljs-string">&#x27;&amp;table_name&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p>复制</p>
<p>对于普通索引直接rebuild online nologging parallel,  对于分区索引，必须单独rebuild 每个分区,  对于组合分区索引,必须单独rebuild 每个子分区。</p>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Move 通过移动数据来来降低HWM，因此需要更多的磁盘空间。  Shrink 通过delete 和 insert， 会产生较多的undo 和redo。</p>
<p>shrink space收缩到数据存储的最小值，alter table move（不带参数）收缩到initial指定值，也可以用alter table test move storage(initial 500k)指定收缩的大小，这样可以达到shrink space效果。</p>
<p>总之，使用Move 效率会高点，但是会导致索引失效。Shrink 会产生undo 和redo，速度相对也慢一点。</p>
<p>转载：</p>
<p>博文学习至David Dai 大神，再此向大神致敬！<br>————————————————<br>版权声明：本文为CSDN博主「小小工匠」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。<br>原文链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/yangshangwei/article/details/53457321">https://blog.csdn.net/yangshangwei/article/details/53457321</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="category-chain-item">数据库</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Oracle%E8%A1%A8%E9%AB%98%E6%B0%B4%E4%BD%8D/" class="print-no-link">#Oracle表高水位</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Oracle-HWM高水位解读</div>
      <div>http://example.com/2023/08/20/Oracle-HWM高水位解读/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Li zhihao</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年8月20日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/08/21/SQL%E6%A6%82%E5%BF%B5%E5%8F%8A%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/" title="SQL概念及数据库表的基本操作">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">SQL概念及数据库表的基本操作</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/08/07/%E8%AE%B0%E5%BD%95npm%E7%BB%8F%E5%B8%B8%E9%81%87%E5%88%B0%E7%9A%84Connt-find-module-xxx%E9%97%AE%E9%A2%98/" title="记录npm经常遇到的Connt find module xxx问题">
                        <span class="hidden-mobile">记录npm经常遇到的Connt find module xxx问题</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="#" target="_blank" rel="nofollow noopener"><span>Lizhihao</span></a> <i class="iconfont icon-love"></i> <a href="#" target="_blank" rel="nofollow noopener"><span>Blog</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
